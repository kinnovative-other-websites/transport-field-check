<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Photo Upload</title>
    <link rel="stylesheet" href="style.css">    
    <style>
       /* Additional styles for thumbnails */
       #thumbnails {
           display: flex;
           flex-wrap: wrap;
           justify-content: center;
           gap: 10px;
           margin-bottom: 15px;
       }
       .thumbnail-container {
           position: relative;
           width: 100px;
           height: 133px; /* 3:4 aspect ratio */
       }
       .thumbnail-container img {
           width: 100%;
           height: 100%;
           object-fit: cover;
           border-radius: 4px;
       }
       .remove-btn {
           position: absolute;
           top: -5px;
           right: -5px;
           background: red;
           color: white;
           border-radius: 50%;
           width: 20px;
           height: 20px;
           border: none;
           cursor: pointer;
           font-size: 12px;
           line-height: 10px;
           display: flex;
           align-items: center;
           justify-content: center;
       }
    </style>
</head>
<body>

<div class="container">
    <h2>Capture & Upload</h2>
    
    <div id="cameraView">
        <video id="video" autoplay playsinline></video>
        <button id="captureBtn">Capture Photo</button>
        <button id="viewGalleryBtn" class="hidden">View Captured (<span id="count">0</span>)</button>
    </div>

    <div id="previewView" class="hidden">
        <h3>Captured Photos</h3>
        <div id="thumbnails"></div>
        
        <div id="locationDisplay">Fetching location...</div>
        
        <button id="addMoreBtn">Add More</button>
        <button id="uploadBtn">Upload All</button>
    </div>

    <div id="statusMessage"></div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas'); // Off-screen canvas
    const captureBtn = document.getElementById('captureBtn');
    const viewGalleryBtn = document.getElementById('viewGalleryBtn');
    const countSpan = document.getElementById('count');
    const addMoreBtn = document.getElementById('addMoreBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const locationDisplay = document.getElementById('locationDisplay');
    const statusMessage = document.getElementById('statusMessage');
    const cameraView = document.getElementById('cameraView');
    const previewView = document.getElementById('previewView');
    const thumbnailsDiv = document.getElementById('thumbnails');

    let currentLat = null;
    let currentLng = null;
    let capturedBlobs = [];

    // Initialize Camera with Portrait constraints
    async function initCamera() {
        try {
            // Try to set aspect ratio to < 1 for portrait, or just rely on 'environment'
            // Ideally width < height. 
            const constraints = { 
                video: { 
                    facingMode: 'environment',
                    // Attempt to enforce portrait aspect ratio if supported
                    aspectRatio: { ideal: 0.75 } 
                } 
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            // Initial location fetch
            if(!currentLat) getLocation();

        } catch (err) {
            console.error("Error accessing camera: ", err);
            statusMessage.textContent = "Error accessing camera. Please allow permissions.";
             statusMessage.style.color = 'red';
        }
    }

    // Capture Photo
    captureBtn.addEventListener('click', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        canvas.toBlob(blob => {
            capturedBlobs.push(blob);
            updateUI();
            
            // Briefly show feedback
            const originalText = captureBtn.innerText;
            captureBtn.innerText = "Captured!";
            setTimeout(() => captureBtn.innerText = originalText, 500);

            viewGalleryBtn.classList.remove('hidden');

            // If we have location, fine. If not, fetching continues in background/init
        }, 'image/jpeg');
    });

    function updateUI() {
        countSpan.textContent = capturedBlobs.length;
        renderThumbnails();
    }

    function renderThumbnails() {
        thumbnailsDiv.innerHTML = '';
        capturedBlobs.forEach((blob, index) => {
            const container = document.createElement('div');
            container.className = 'thumbnail-container';

            const img = document.createElement('img');
            img.src = URL.createObjectURL(blob);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = () => {
                capturedBlobs.splice(index, 1);
                updateUI();
                if(capturedBlobs.length === 0) {
                     addMoreBtn.click(); // Go back to camera if empty
                     viewGalleryBtn.classList.add('hidden');
                }
            };

            container.appendChild(img);
            container.appendChild(removeBtn);
            thumbnailsDiv.appendChild(container);
        });
    }

    // View Gallery / Done Capturing
    viewGalleryBtn.addEventListener('click', () => {
        cameraView.classList.add('hidden');
        previewView.classList.remove('hidden');
    });

    // Add More (Return to Camera)
    addMoreBtn.addEventListener('click', () => {
        previewView.classList.add('hidden');
        cameraView.classList.remove('hidden');
        statusMessage.textContent = "";
    });

    // Get Geolocation
    function getLocation() {
        if (!navigator.geolocation) {
            locationDisplay.textContent = "Geolocation is not supported by your browser.";
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentLat = position.coords.latitude;
                currentLng = position.coords.longitude;
                locationDisplay.textContent = `Lat: ${currentLat.toFixed(6)}, Lng: ${currentLng.toFixed(6)}`;
                uploadBtn.disabled = false;
            },
            () => {
                locationDisplay.textContent = "Unable to retrieve your location.";
                statusMessage.textContent = "Location access denied. Cannot upload without location.";
                statusMessage.style.color = 'red';
                uploadBtn.disabled = true;
            }
        );
    }

    // Upload All
    uploadBtn.addEventListener('click', async () => {
        if (capturedBlobs.length === 0 || currentLat === null || currentLng === null) {
            statusMessage.textContent = "No photos or location missing.";
             statusMessage.style.color = 'red';
            return;
        }

        statusMessage.textContent = "Uploading...";
        statusMessage.style.color = 'blue';
        uploadBtn.disabled = true;
        addMoreBtn.disabled = true;

        const formData = new FormData();
        capturedBlobs.forEach((blob, i) => {
            formData.append('photos', blob, `photo_${i}.jpg`);
        });
        formData.append('latitude', currentLat);
        formData.append('longitude', currentLng);

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                statusMessage.textContent = "Upload successful!";
                statusMessage.style.color = 'green';
                
                // Clear data
                capturedBlobs = [];
                updateUI();
                
                setTimeout(() => {
                    // Reset to camera view
                    addMoreBtn.click(); 
                    uploadBtn.disabled = false;
                    addMoreBtn.disabled = false;
                    statusMessage.textContent = "";
                    viewGalleryBtn.classList.add('hidden');
                }, 2000);
            } else {
                throw new Error(result.error || 'Upload failed');
            }
        } catch (error) {
            console.error('Error:', error);
            statusMessage.textContent = `Upload failed: ${error.message}`;
            statusMessage.style.color = 'red';
            uploadBtn.disabled = false;
            addMoreBtn.disabled = false;
        }
    });

    // Start camera on load
    initCamera();
</script>

</body>
</html>
